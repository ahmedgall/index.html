<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدرب Calzy AI | الإصدار المستقر</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --p: #8b5cf6; --bg: #05070a; --card: #111827; --text: #f9fafb; --s: #10b981; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        .header { padding: 15px 20px; background: var(--card); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: space-between; }
        .back-btn { color: white; text-decoration: none; display: flex; align-items: center; gap: 8px; font-weight: bold; }
        .status { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--s); }
        .dot { width: 8px; height: 8px; background: var(--s); border-radius: 50%; box-shadow: 0 0 8px var(--s); }

        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg { max-width: 85%; padding: 12px 18px; border-radius: 20px; font-size: 14px; line-height: 1.6; animation: fadeIn 0.3s ease; word-wrap: break-word; }
        .bot { background: var(--card); border: 1px solid rgba(139, 92, 246, 0.2); align-self: flex-start; border-bottom-right-radius: 2px; }
        .user { background: var(--p); align-self: flex-end; border-bottom-left-radius: 2px; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.2); }

        .input-area { padding: 20px; background: var(--card); border-top: 1px solid rgba(255,255,255,0.05); }
        .input-wrapper { display: flex; gap: 10px; background: #1f2937; padding: 6px; border-radius: 18px; border: 1px solid #374151; }
        input { flex: 1; background: transparent; border: none; padding: 10px 15px; color: white; outline: none; font-size: 15px; }
        button { background: var(--p); border: none; width: 45px; height: 45px; border-radius: 14px; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; }

        .typing { display: none; align-self: flex-start; background: var(--card); padding: 12px; border-radius: 15px; margin-bottom: 10px; }
        .dots { display: flex; gap: 4px; }
        .dots span { width: 5px; height: 5px; background: var(--p); border-radius: 50%; animation: bounce 1.4s infinite; }
        .dots span:nth-child(2) { animation-delay: 0.2s; }
        .dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce { 0%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-5px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="header">
    <a href="index.html" class="back-btn">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 12H5m7 7l-7-7 7-7"></path></svg>
        الرئيسية
    </a>
    <div class="status"> <div class="dot"></div> مدرب Calzy AI </div>
</div>

<div id="chat-box"></div>

<div id="typing" class="typing msg">
    <div class="dots"><span></span><span></span><span></span></div>
</div>

<div class="input-area">
    <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="اسأل مدربك الذكي..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()" id="sendBtn">
            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
        </button>
    </div>
</div>

<script>
    // مفتاح الـ API الخاص بك
    const API_KEY = "AIzaSyAKqNlOzS-C0NdKD4Y2nUg70UBdcf6ZKw4";
    const chatBox = document.getElementById('chat-box');

    window.onload = () => {
        const savedChat = JSON.parse(localStorage.getItem('calzy_ai_history')) || [
            { role: 'bot', text: 'أهلاً بك يا بطل! أنا مدربك الذكي. اسألني عن التمارين، التغذية، أو المكملات.' }
        ];
        savedChat.forEach(msg => appendToUI(msg.text, msg.role));
    };

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text) return;

        saveAndAppend(text, 'user');
        input.value = '';

        const typingIndicator = document.getElementById('typing');
        typingIndicator.style.display = 'block';
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            // استخدام نموذج gemini-pro المستقر
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEY}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `أنت خبير تغذية ورياضة. أجب باختصار وباللغة العربية: ${text}` }] }]
                })
            });

            const data = await response.json();

            if (data.error) {
                console.error("API Error:", data.error);
                // معالجة خطأ الحظر الجغرافي أو المفتاح
                if(data.error.status === "PERMISSION_DENIED") {
                    appendToUI("عذراً، يبدو أن الخدمة غير متوفرة في منطقتك حالياً أو أن هناك مشكلة في صلاحية المفتاح.", "bot");
                } else {
                    appendToUI("حدث خطأ تقني: " + data.error.message, "bot");
                }
            } else if (data.candidates && data.candidates[0].content) {
                const aiMsg = data.candidates[0].content.parts[0].text;
                saveAndAppend(aiMsg, 'bot');
            } else {
                appendToUI("وصل رد غير متوقع من الخادم، جرب صياغة السؤال بشكل مختلف.", "bot");
            }

        } catch (error) {
            console.error("Fetch Error:", error);
            appendToUI("تعذر الاتصال بالخادم. تأكد من أن الموقع يعمل عبر رابط HTTPS (مثل GitHub Pages).", "bot");
        } finally {
            typingIndicator.style.display = 'none';
        }
    }

    function saveAndAppend(text, role) {
        appendToUI(text, role);
        const history = JSON.parse(localStorage.getItem('calzy_ai_history')) || [];
        history.push({ role, text });
        localStorage.setItem('calzy_ai_history', JSON.stringify(history.slice(-15))); // حفظ آخر 15 رسالة
    }

    function appendToUI(text, role) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        // تنظيف النص من التنسيقات الزائدة
        div.innerText = text.replace(/\*/g, ""); 
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

</body>
</html>

