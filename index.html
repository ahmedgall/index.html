<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calzy | Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø®Ø§Ø±Ù‚</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        :root { --p: #8b5cf6; --bg: #05070a; --card: #111827; --text: #f9fafb; --s: #10b981; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        #video { width: 100%; height: 40vh; object-fit: cover; background: #000; }
        .scanner-box { position: relative; border-bottom: 3px solid var(--p); }
        .overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 120px; border: 2px solid var(--s); border-radius: 10px; pointer-events: none; }
        .results { flex: 1; padding: 20px; background: var(--card); border-radius: 25px 25px 0 0; margin-top: -20px; text-align: center; overflow-y: auto; }
        .status-badge { padding: 5px 15px; border-radius: 50px; background: rgba(139, 92, 246, 0.2); color: var(--p); font-size: 13px; margin-bottom: 10px; display: inline-block; }
        .data-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-top: 10px; border: 1px solid #1f2937; text-align: right; }
        .btn { width: 100%; padding: 15px; background: var(--p); color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 15px; cursor: pointer; }
    </style>
</head>
<body>

<div class="scanner-box">
    <video id="video"></video>
    <div class="overlay"></div>
</div>

<div class="results">
    <div id="status" class="status-badge">ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</div>
    <div id="barcode-num" style="font-size: 12px; opacity: 0.5; margin-bottom: 10px;">Ù„Ù… ÙŠØªÙ… Ø±ØµØ¯ ÙƒÙˆØ¯ Ø¨Ø¹Ø¯</div>
    
    <div id="product-card" class="data-item" style="display:none;">
        <h3 id="p-name" style="color:var(--s); margin-bottom:5px;">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</h3>
        <p id="p-macros" style="font-size: 14px; line-height: 1.6;"></p>
    </div>

    <button id="retry" class="btn" style="display:none;" onclick="location.reload()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø³Ø­</button>
</div>

<script>
    const codeReader = new ZXing.BrowserMultiFormatReader();
    const status = document.getElementById('status');
    const barcodeNum = document.getElementById('barcode-num');
    const pCard = document.getElementById('product-card');

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
    codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
        if (result) {
            vibrate();
            status.innerText = "ØªÙ… Ø§Ù„Ø±ØµØ¯ âœ…";
            barcodeNum.innerText = "Ø±Ù‚Ù… Ø§Ù„ÙƒÙˆØ¯: " + result.text;
            searchProduct(result.text);
            codeReader.reset(); // ØªÙˆÙ‚Ù Ø¨Ø¹Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
        }
    });

    function vibrate() { if (navigator.vibrate) navigator.vibrate(100); }

    async function searchProduct(code) {
        status.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª...";
        pCard.style.display = 'block';
        document.getElementById('p-name').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        document.getElementById('p-macros').innerText = "";
        document.getElementById('retry').style.display = 'block';

        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
            const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
            const data = await response.json();

            if (data.status === 1) {
                const p = data.product;
                document.getElementById('p-name').innerText = p.product_name || "Ù…Ù†ØªØ¬ Ù…Ø¹Ø±ÙˆÙ";
                document.getElementById('p-macros').innerHTML = `
                    ğŸ”¥ Ø§Ù„Ø³Ø¹Ø±Ø§Øª: ${p.nutriments['energy-kcal_100g'] || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'} Ø³Ø¹Ø±Ø©<br>
                    ğŸ’ª Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†: ${p.nutriments.proteins_100g || '0'} Ø¬Ù…<br>
                    ğŸš Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª: ${p.nutriments.carbohydrates_100g || '0'} Ø¬Ù…<br>
                    ğŸ¥¤ Ø§Ù„Ø³ÙƒØ±: ${p.nutriments.sugars_100g || '0'} Ø¬Ù…
                `;
            } else {
                // Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ Ù„Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø´ Ø¹Ø§Ø±Ù Ø§Ù„Ø¨ÙŠØ¨Ø³ÙŠ
                const backupDB = {
                    "6221012101117": { n: "Ø¨ÙŠØ¨Ø³ÙŠ ÙƒØ§Ù†Ø² 330Ù…Ù„", m: "Ø§Ù„Ø³Ø¹Ø±Ø§Øª: 139 Ø³Ø¹Ø±Ø© | Ø§Ù„Ø³ÙƒØ±: 35 Ø¬Ù…" },
                    "6221003002041": { n: "Ù…ÙˆÙ„ØªÙˆ Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ©", m: "Ø§Ù„Ø³Ø¹Ø±Ø§Øª: 280 Ø³Ø¹Ø±Ø© | Ø¨Ø±ÙˆØªÙŠÙ†: 5Ø¬Ù…" }
                };

                if (backupDB[code]) {
                    document.getElementById('p-name').innerText = backupDB[code].n;
                    document.getElementById('p-macros').innerText = backupDB[code].m;
                } else {
                    document.getElementById('p-name').innerText = "Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯ (ÙƒÙˆØ¯: " + code + ")";
                    document.getElementById('p-macros').innerText = "Ù„Ù„Ø£Ø³Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø´ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØŒ Ù„Ø§Ø²Ù… ØªØ·Ù„Ø¨Ù‡ ÙŠØ¯ÙˆÙŠ.";
                }
            }
        } catch (e) {
            status.innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!";
        }
    }
</script>
</body>
</html>
